#!/data/data/com.termux/files/usr/bin/bash
# Versi otomatis berdasarkan Git
VERSION=$(git describe --tags --always 2>/dev/null || echo "v0.0.0-dev")

# Cek apakah ingin menampilkan versi saja
if [[ "$1" == "--version" || "$1" == "-v" ]]; then
    echo "ADYT version $VERSION"
    exit 0
fi

figlet "YT Downloader"
echo "ADYT Downloader $VERSION"

# Respon berdasarkan pola percobaan
declare -A RESPON_PEMBUKA=(
    ["x"]="Tidak dapat memproses permintaan Anda karena tautan YouTube kosong. Silakan lengkapi dan coba lagi."
    ["?"]="Tidak dapat memproses permintaan Anda karena tautan/input yang dimasukkan bukan berasal dari YouTube.\
Mungkin kamu typo, Silakan periksa kembali dan coba lagi dengan URL yang berasal dari YouTube."
)

declare -A RESPON_TENGAH=(
    ["xx"]="Tautan YouTube masih belum dimasukkan. Sistem tidak dapat melanjutkan permintaan Anda tanpa input yang valid. Silakan tulis atau tempelkan URL dengan benar lalu coba kembali"
    ["x?"]="Inputnya memang tidak kosong, tapi saat dicoba ternyata bukan URL YouTube. Mohon pastikan URL yang Anda tulis atau tempel berasal dari YouTube dan tidak typo"
    ["?x"]="Input sebelumnya bukan URL YouTube, dan sekarang malah kosong. Silakan periksa kembali dan pastikan Anda menyalin tautan dengan benar sebelum mencoba ulang"
    ["??"]="[Error ??] Tautan tidak valid dan bukan dari YouTube, Silakan teliti kembali link yang Anda gunakan dan pastikan itu URL YouTube yang benar"
)

declare -A RESPON_PENUTUP=(
    ["xxx"]="Tautan YouTube belum juga dimasukkan setelah beberapa percobaan. Sistem tidak dapat memproses permintaan Anda tanpa input yang valid. Silakan coba kembali dengan menjalankan ulang program"
    ["xx?"]="percobaan terakhir gagal, [Error xx?] 2 kali input kosong dan terakhir salah.mungkin kamu terlalu buru. silahkan coba kembali dengam menjalankan ulang program"
    ["x?x"]="Input sebelumnya kosong, lalu diberikan URL yang tidak valid, dan sekarang malah kosong lagi. Mohon pastikan Anda menyalin tautan YouTube dengan benar sebelum mencoba kembali."
    ["x??"]="Awalnya belum ada tautan, lalu dua kali berturut-turut diberikan input yang bukan berasal dari YouTube. Silakan pastikan Anda menyalin URL dari YouTube secara lengkap dan benar sebelum mencoba kembali."
    ["?xx"]="Input sebelumnya bukan berasal dari YouTube, lalu dua kali berturut-turut tidak ada tautan yang dimasukkan. Pastikan Anda menyalin URL dengan benar dari YouTube sebelum melanjutkan."
    ["?x?"]="Input pertama bukan URL YouTube, lalu kosong, dan terakhir tetap bukan tautan yang valid. Silakan periksa kembali dan pastikan Anda menggunakan URL asli dari YouTube sebelum mencoba kembali."
    ["??x"]="[Error ??x] Dua input sebelumnya bukan tautan YouTube, dan sekarang tidak ada tautan yang dimasukkan sama sekali. Silakan tempelkan URL yang valid dari YouTube agar permintaan dapat diproses."  
    ["???"]="[Error ???] Tiga kali berturut-turut menerima input yang bukan berasal dari YouTube. Mohon pastikan URL yang digunakan adalah benar-benar dari YouTube sebelum mencoba kembali."
)
# Inisialisasi log percobaan
polanya=""

# Tangkap Ctrl+C dan abaikan atau beri pesan
trap 'echo -e "\n[Error 100] Tidak bisa keluar dengan Ctrl+C. Gunakan opsi 100 untuk keluar dengan benar.";' SIGINT

# Loop maksimum 3 kali
for ((i = 1; i <= 3; i++)); do
    read -p "Masukkan URL YouTube: " YTURL

    # Tangani opsi keluar
        if [[ "$YTURL" == "100" ]]; then
            echo "Program dihentikan oleh pengguna"
            exit 0
        fi

    if [[ -z "$YTURL" ]]; then
        polanya+="x"
    elif ! echo "$YTURL" | grep -Eq '^https?://(www\.)?(youtube\.com|youtu\.be)/'; then
        polanya+="?"
    else
        break  # input valid
    fi

    # Tampilkan respon berdasarkan percobaan
    if [[ $i == 1 ]]; then
        [[ -v RESPON_PEMBUKA["${polanya:0:1}"] ]] && echo "${RESPON_PEMBUKA[${polanya:0:1}]}"
    elif [[ $i == 2 ]]; then
        [[ -v RESPON_TENGAH["${polanya:0:2}"] ]] && echo "${RESPON_TENGAH[${polanya:0:2}]}"
    else
        [[ -v RESPON_PENUTUP["${polanya:0:3}"] ]] && echo "${RESPON_PENUTUP[${polanya:0:3}]}"
        echo "Percobaan gagal. Program berhenti."
        exit 1
    fi
done

clear

echo "Mengambil daftar kualitas dari $YTURL..."
yt-dlp -F "$YTURL" > "$HOME/.yt_formats.txt"
# ===== TAMPILKAN VIDEO =====
echo "╔══════════════════════════════════════════╗"
echo "║               FORMAT VIDEO               ║"
echo "╠════╦═════╦═══════════╦═════╦═════════════╣"
echo "║ No ║ ID  ║ Resolusi  ║ FPS ║    Size     ║"
echo "╠════╬═════╬═══════════╬═════╬═════════════╣"
awk '
/video only/ {
    no+=1
    id=$1
    res=$3
    fps=$4
    size="?"
    for (i=1;i<=NF;i++) {
        if ($i ~ /MiB/ || $i ~ /KiB/) {
            size=$i
            break
        }
    }
    printf "║ %-2d ║ %-3s ║ %-9s ║ %-3s ║ %-11s ║\n", no, id, res, fps, size
    map[no]=id
}
END { 
     print "╚════╩═════╩═══════════╩═════╩═════════════╝"
     for (i in map) print map[i] > "'$HOME'/.vid_id_map.txt" }
' "$HOME/.yt_formats.txt"

# Hitung jumlah baris dalam daftar video
TOTAL_VID=$(wc -l < "$HOME/.vid_id_map.txt")

while true; do
    read -p "Pilih nomor video (99 = audio saja, 100 = keluar): " VIDNUM

    if [[ "$VIDNUM" = "99" ]]; then
        echo "Anda memilih audio saja."
        VIDFORMAT=""
        break

    elif [[ "$VIDNUM" = "100" ]]; then
        echo "Program dihentikan oleh pengguna."
        exit 0

    elif [[ "$VIDNUM" =~ ^[0-9]+$ ]] && [ "$VIDNUM" -ge 1 ] && [ "$VIDNUM" -le "$TOTAL_VID" ]; then
        VIDFORMAT=$(sed -n "${VIDNUM}p" "$HOME/.vid_id_map.txt")
        echo "Format video terpilih: $VIDFORMAT"
        break

    else
        echo "Nomor \"$VIDNUM\" tidak tersedia. Silakan pilih angka 1–$TOTAL_VID, 99 untuk audio saja, atau 100 untuk keluar."
    fi
done

# ===== TAMPILKAN AUDIO =====
echo "╔════════════════════════════════════════════════════════════════════╗"
echo "║                            FORMAT AUDIO                            ║"
echo "╠════╦═════════╦═══════════════╦═════════════════╦═══════════════════╣"
echo "║ No ║   ID    ║ Total Bitrate ║ Average Bitrate ║ Audio Sample Rate ║"
echo "╠════╬═════════╬═══════════════╬═════════════════╬═══════════════════╣"
awk '
BEGIN {
    FS = " +"
    no = 0
    found_header = 0
}
# Temukan posisi kolom dari header
/^ID[ \t]+EXT/ {
    for (i = 1; i <= NF; i++) {
        if ($i == "ID") id_col = i
        else if ($i == "TBR") tbr_col = i
        else if ($i ~ /ABR/) abr_col = i
        else if ($i == "ASR") asr_col = i
    }
    found_header = 1
    next
}

# Proses baris setelah header, hanya jika semua kolom tersedia
found_header && /audio only/ {
    id  = (id_col ? $id_col : "")
    tbr = (tbr_col ? $tbr_col : "")
    abr = (abr_col ? $abr_col : "")
    asr_raw = (asr_col ? $asr_col : "")

    # Konversi ASR misalnya 44k menjadi 44100 Hz
        if (asr_raw ~ /^[0-9]+k$/) {
            rate = substr(asr_raw, 1, length(asr_raw)-1)
            asr = rate * 1000 " Hz"
        } else {
            asr = "?"
        }

    # Cek apakah semua field terisi
    if (id != "" && tbr != "" && abr != "" && asr != "") 
    {
        no++
        abr_display = abr
        gsub(/k$/, " kbps", abr_display)
 	    tbr_display = tbr
	    gsub(/k$/, " kbps", tbr_display)
        printf "║ %-2d ║ %-7s ║ %-13s ║ %-15s ║ %-17s ║\n", no, id, tbr_display, abr_display, asr
        map[no] = id
    }
}

END {
	 print "╚════╩═════════╩═══════════════╩═════════════════╩═══════════════════╝"
    for (i in map)
        print map[i] > "'$HOME'/.aud_id_map.txt"
}
' "$HOME/.yt_formats.txt"

# Hitung jumlah baris dalam daftar audio
TOTAL_AUD=$(wc -l < "$HOME/.aud_id_map.txt")

while true; do
    read -p "Pilih nomor audio (99 = hanya video, 100 = keluar): " AUDNUM

    if [[ "$AUDNUM" == "99" ]]; then
        echo "Anda memilih video saja tanpa audio."
        AUDFORMAT=""
        break

    elif [[ "$AUDNUM" == "100" ]]; then
        echo "Program dihentikan oleh pengguna."
        exit 0

    elif [[ "$AUDNUM" =~ ^[0-9]+$ ]] && [ "$AUDNUM" -ge 1 ] && [ "$AUDNUM" -le "$TOTAL_AUD" ]; then
        AUDFORMAT=$(sed -n "${AUDNUM}p" "$HOME/.aud_id_map.txt")
        echo "Format audio terpilih: $AUDFORMAT"
        break

    else
        echo "Nomor \"$AUDNUM\" tidak tersedia. Silakan pilih angka 1–$TOTAL_AUD, 99 untuk tanpa audio, atau 100 untuk keluar."
    fi
done

# ===== GABUNGKAN FORMAT =====
if [ -n "$VIDFORMAT" ]; then
    FORMAT="${VIDFORMAT}+${AUDFORMAT}"
else
    FORMAT="$AUDFORMAT"
fi

# ===== FORMAT OUTPUT =====
echo
echo "========== PILIH FORMAT OUTPUT =========="
echo "1) mp4"
echo "2) webm"
echo "3) mp3 (audio saja)"
read -p "Pilih: " OUTEXT

case $OUTEXT in
    1) EXT="mp4" ;;
    2) EXT="webm" ;;
    3) EXT="mp3" ;;
    *) echo "Pilihan tidak valid. Default ke mp4."; EXT="mp4" ;;
esac

# ===== LOKASI SIMPAN =====
TEMPPATH="$HOME/downloads/yt"
mkdir -p "$TEMPPATH"

# ===== MULAI DOWNLOAD =====
echo "Download ke: $TEMPPATH (format: $EXT)"
yt-dlp -f "$FORMAT" -o "$TEMPPATH/%(title).100s.%(ext)s" \
         --merge-output-format "$EXT" --external-downloader aria2c \
         --external-downloader-args aria2c:"-x 16 -s 16 -k 1M" --no-warnings "$YTURL"


FILENAME=$(yt-dlp -f "$FORMAT" -o "$TEMPPATH/%(title).100s.%(ext)s" \
           --merge-output-format "$EXT" --print filename "$YTURL")

BASE="$HOME/storage/shared/"
while true; do
    CHOICE=$(find "$BASE" -maxdepth 1 -mindepth 1 -type d ! -name ".*" | fzf --prompt="Pilih folder di: $BASE ")

    # Jika tidak ada pilihan (user tekan Esc), keluar dari loop
    if [ -z "$CHOICE" ]; then
        break
    fi

    # Set folder yang dipilih sebagai base baru untuk iterasi berikutnya
    BASE="$CHOICE"
done

SAVEPATH="$BASE"
echo "Folder akhir: $SAVEPATH"

# Jika tidak dipilih (misalnya tekan Esc), gunakan default
if [ -z "$SAVEPATH" ]; then
    SAVEPATH="$HOME/downloads/yt"
fi

mkdir -p "$SAVEPATH"
#pindahkan ke path yg dipilih
mv "$FILENAME" "$SAVEPATH"

# ===== BERSIHKAN SEMENTARA =====
rm -f "$HOME/.yt_formats.txt" "$HOME/.vid_id_map.txt" "$HOME/.aud_id_map.txt"
