#!/data/data/com.termux/files/usr/bin/bash
# Versi otomatis berdasarkan Git
VERSION=$(git describe --tags --always 2>/dev/null || echo "v0.0.0-dev")

# Cek apakah ingin menampilkan versi saja
if [[ "$1" == "--version" || "$1" == "-v" ]]; then
    echo "ADYT version $VERSION"
    exit 0
fi

figlet "YT Downloader"
echo "ADYT Downloader $VERSION"
read -p "Masukkan URL YouTube: " YTURL
if [ -z "$YTURL" ]; then
    echo "URL kosong. Keluar."
    exit 1
fi

clear

echo "Mengambil daftar kualitas dari $YTURL..."
yt-dlp -F "$YTURL" > "$HOME/.yt_formats.txt"
# ===== TAMPILKAN VIDEO =====
echo "╔════════════════════════════════════════╗"
echo "║             PILIHAN VIDEO              ║"
echo "╠════╦═════╦═══════════╦═════╦═══════════╣"
echo "║ No ║ ID  ║ Resolusi  ║ FPS ║   Size    ║"
echo "╠════╬═════╬═══════════╬═════╬═══════════╣"
awk '
/video only/ {
    no+=1
    id=$1
    res=$3
    fps=$4
    size="?"
    for (i=1;i<=NF;i++) {
        if ($i ~ /MiB/ || $i ~ /KiB/) {
            size=$i
            break
        }
    }
    printf "║ %-2d ║ %-3s ║ %-9s ║ %-3s ║ %-9s ║\n", no, id, res, fps, size
    map[no]=id
}
END { 
     print "╚════╩═════╩═══════════╩═════╩═══════════╝"
     for (i in map) print map[i] > "'$HOME'/.vid_id_map.txt" }
' "$HOME/.yt_formats.txt"

read -p "Pilih nomor video (kosongkan jika ingin audio saja): " VIDNUM
VIDFORMAT=""
if [ -n "$VIDNUM" ]; then
    VIDFORMAT=$(sed -n "${VIDNUM}p" "$HOME/.vid_id_map.txt")
fi

# ===== TAMPILKAN AUDIO =====
echo
echo "========== PILIHAN AUDIO =========="
echo "No | ID   | Codec   | Bitrate | Asr "
echo "-------------------------------------"
awk '
BEGIN {
    FS = " +"
    no = 0
    found_header = 0
}
# Temukan posisi kolom dari header
/^ID[ \t]+EXT/ {
    for (i = 1; i <= NF; i++) {
        if ($i == "ID") id_col = i
        else if ($i == "TBR") tbr_col = i
        else if ($i ~ /ABR/) abr_col = i
        else if ($i == "ASR") asr_col = i
    }
    found_header = 1
    next
}

# Proses baris setelah header, hanya jika semua kolom tersedia
found_header && /audio only/ {
    id  = (id_col ? $id_col : "")
    tbr = (tbr_col ? $tbr_col : "")
    abr = (abr_col ? $abr_col : "")
    asr = (asr_col ? $asr_col : "")

    # Cek apakah semua field terisi
    if (id != "" && tbr != "" && abr != "" && asr != "") {
        no++
        printf "%-2d | %-4s | %-6s | %-7s | %s\n", no, id, tbr, abr, asr
        map[no] = id
    }
}

END {
    for (i in map)
        print map[i] > "'$HOME'/.aud_id_map.txt"
}
' "$HOME/.yt_formats.txt"

read -p "Pilih nomor audio: " AUDNUM
AUDFORMAT=$(sed -n "${AUDNUM}p" "$HOME/.aud_id_map.txt")

if [ -z "$AUDFORMAT" ]; then
    echo "Audio tidak dipilih. Keluar."
    exit 1
fi

# ===== GABUNGKAN FORMAT =====
if [ -n "$VIDFORMAT" ]; then
    FORMAT="${VIDFORMAT}+${AUDFORMAT}"
else
    FORMAT="$AUDFORMAT"
fi

# ===== FORMAT OUTPUT =====
echo
echo "========== PILIH FORMAT OUTPUT =========="
echo "1) mp4"
echo "2) webm"
echo "3) mp3 (audio saja)"
read -p "Pilih: " OUTEXT

case $OUTEXT in
    1) EXT="mp4" ;;
    2) EXT="webm" ;;
    3) EXT="mp3" ;;
    *) echo "Pilihan tidak valid. Default ke mp4."; EXT="mp4" ;;
esac

# ===== LOKASI SIMPAN =====
TEMPPATH="$HOME/downloads/yt"
mkdir -p "$TEMPPATH"

# ===== MULAI DOWNLOAD =====
echo "Download ke: $TEMPPATH (format: $EXT)"
yt-dlp -f "$FORMAT" -o "$TEMPPATH/%(title).100s.%(ext)s" \
         --merge-output-format "$EXT" --external-downloader aria2c \
         --external-downloader-args aria2c:"-x 16 -s 16 -k 1M" --no-warnings "$YTURL"


FILENAME=$(yt-dlp -f "$FORMAT" -o "$TEMPPATH/%(title).100s.%(ext)s" \
           --merge-output-format "$EXT" --print filename "$YTURL")

BASE="$HOME/storage/shared/"
while true; do
    CHOICE=$(find "$BASE" -maxdepth 1 -mindepth 1 -type d ! -name ".*" | fzf --prompt="Pilih folder di: $BASE ")

    # Jika tidak ada pilihan (user tekan Esc), keluar dari loop
    if [ -z "$CHOICE" ]; then
        break
    fi

    # Set folder yang dipilih sebagai base baru untuk iterasi berikutnya
    BASE="$CHOICE"
done

SAVEPATH="$BASE"
echo "Folder akhir: $SAVEPATH"

# Jika tidak dipilih (misalnya tekan Esc), gunakan default
if [ -z "$SAVEPATH" ]; then
    SAVEPATH="$HOME/downloads/yt"
fi

mkdir -p "$SAVEPATH"
#pindahkan ke path yg dipilih
mv "$FILENAME" "$SAVEPATH"

# ===== BERSIHKAN SEMENTARA =====
rm -f "$HOME/.yt_formats.txt" "$HOME/.vid_id_map.txt" "$HOME/.aud_id_map.txt"
